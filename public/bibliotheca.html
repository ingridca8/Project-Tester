<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Bibliotheca</title>

  <!-- Supabase client -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

  <!-- Fonts -->
  <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@400;600;700&family=Lora:wght@400;700&display=swap" rel="stylesheet">

  <style>
    :root{
      --ivory: #FDFBF7;
      --ink: #3B322C;
      --gold: #A3874A;
      --olive: #6E8B74;
      --soft: rgba(58,45,34,0.06);
      --card: #fffdf8;
      --muted: #7b7165;
      --glass: rgba(255,255,255,0.6);
      --shadow: rgba(40,30,20,0.08);
    }
    *{box-sizing:border-box}
    html,body{height:100%; margin:0; font-family:Lora, serif; background:var(--ivory); color:var(--ink); -webkit-font-smoothing:antialiased; -moz-osx-font-smoothing:grayscale;}

    /* subtle paper texture built with layered gradients (no external image) */
    body::before{
      content:"";
      position:fixed; inset:0; z-index:-2;
      background:
        radial-gradient(1200px 500px at 10% 10%, rgba(163,135,74,0.03), transparent 10%),
        radial-gradient(800px 350px at 85% 85%, rgba(110,139,116,0.02), transparent 15%),
        linear-gradient(180deg, rgba(245,240,232,1), rgba(252,250,247,1));
      pointer-events:none;
    }
    body::after{
      content:"";
      position:fixed; inset:0; z-index:-1; opacity:0.25;
      background-image:
        linear-gradient(0deg, rgba(255,255,255,0.02) 0 2px, transparent 2px 4px);
      pointer-events:none;
      mix-blend-mode: multiply;
    }

    .page {
      max-width:1100px;
      margin:36px auto;
      padding:28px;
    }

    header {
      display:flex;
      flex-direction:column;
      gap:10px;
      align-items:center;
      margin-bottom:18px;
    }

    .stats {
        display: flex;
        justify-content: center;
        gap: 3rem;
        margin: 2rem 0;
        color: #3B322C; /* dark ink */
    }

    .stat {
        text-align: center;
        background-color: rgba(255, 255, 255, 0.6);
        padding: 1.5rem 2rem;
        border-radius: 12px;
        box-shadow: 0 2px 6px rgba(0, 0, 0, 0.1);
        backdrop-filter: blur(3px);
    }

    .stat h2 {
        font-family: 'Playfair Display', serif;
        font-size: 2rem;
        color: #6E8B74; /* muted olive green */
        margin-bottom: 0.3rem;
    }

    .stat p {
        font-family: 'Lora', serif;
        font-size: 0.9rem;
        color: #3B322C;
    }

    .form select {
        width: 100%;
        padding: 0.6rem;
        border-radius: 8px;
        border: 1px solid #d0c7b9;
        background-color: rgba(255, 255, 255, 0.8);
        font-family: 'Lora', serif;
        color: #3B322C;
    }

    .brand {
      display:flex;
      align-items:end;
      gap:14px;
    }
    h1 {
      margin:0;
      font-family:'Playfair Display', serif;
      font-weight:700;
      color:var(--ink);
      font-size:40px;
      letter-spacing:0.6px;
    }
    .tagline {
      color:var(--muted);
      font-size:13px;
      margin-bottom:6px;
      margin-left:4px;
    }

    .stage {
      background: linear-gradient(180deg, rgba(255,255,255,0.9), rgba(255,255,248,0.95));
      border-radius:14px;
      padding:18px;
      border:1px solid var(--soft);
      box-shadow: 0 18px 40px var(--shadow);
    }

    /* controls */
    .controls {
      display:flex;
      gap:12px;
      align-items:center;
      margin-bottom:18px;
      justify-content:space-between;
    }

    .left-controls { display:flex; gap:12px; align-items:center; flex:1; }
    .search {
      flex:1;
    }
    .search input {
      width:100%;
      padding:10px 12px;
      border-radius:10px;
      border:1px solid rgba(60,50,40,0.06);
      background:transparent;
      font-size:14px;
      color:var(--ink);
      box-shadow: 0 4px 12px rgba(20,15,10,0.03);
      font-family: Lora, serif;
    }

    .filters { display:flex; gap:8px; }
    .filters select {
      padding:9px 10px; border-radius:8px; border:1px solid rgba(0,0,0,0.05); background:var(--card); color:var(--ink); font-size:13px;
    }

    /* catalog */
    .catalog {
      display:grid;
      grid-template-columns: repeat(auto-fill, minmax(260px, 1fr));
      gap:16px;
      margin-top:8px;
    }

    .card {
      background: var(--card);
      border-radius:12px;
      padding:14px;
      box-shadow: 0 8px 20px rgba(20,14,8,0.04);
      border: 1px solid rgba(0,0,0,0.04);
      display:flex;
      flex-direction:column;
      gap:8px;
      transition: transform 180ms ease, box-shadow 180ms ease;
    }
    .card:hover { transform: translateY(-6px); box-shadow: 0 18px 40px rgba(20,14,8,0.06); }

    .card h3 {
      margin:0;
      font-family:'Playfair Display', serif;
      font-size:18px;
      color:var(--ink);
      line-height:1.1;
    }
    .meta { color:var(--muted); font-size:13px; margin-top:4px; }
    .notes { margin-top:8px; color:var(--ink); font-size:14px; min-height:36px; opacity:0.95; }

    .card .row { display:flex; justify-content:space-between; align-items:center; gap:8px; margin-top:8px; }
    .badge {
      padding:6px 8px; border-radius:8px; font-size:12px; font-weight:700;
      background: linear-gradient(180deg, rgba(163,135,74,0.08), rgba(163,135,74,0.04));
      color:var(--gold);
      border:1px solid rgba(163,135,74,0.06);
    }
    .muted { color:var(--muted); font-size:12px; }

    .actions {
      display:flex;
      gap:8px;
      align-items:center;
    }
    .tiny {
      padding:6px 8px; border-radius:8px; border:1px solid rgba(0,0,0,0.06); background:transparent; cursor:pointer; font-size:13px; color:var(--olive);
    }
    .tiny.danger { color:#8a2b2b; border-color: rgba(138,43,43,0.06) }

    /* floating add button */
    .fab {
      position:fixed;
      right:28px;
      bottom:28px;
      background: linear-gradient(180deg, var(--gold), #caa86a);
      color:#2b2216;
      padding:14px 16px;
      border-radius:12px;
      border: none;
      font-weight:700;
      box-shadow: 0 18px 40px rgba(40,30,20,0.12);
      cursor:pointer;
      z-index:80;
      font-family: 'Playfair Display', serif;
      letter-spacing:0.3px;
    }

    /* modal overlay */
    .overlay {
      position:fixed;
      inset:0;
      background: rgba(20,16,12,0.25);
      display:flex;
      align-items:center;
      justify-content:center;
      z-index:90;
      opacity:0;
      pointer-events:none;
      transition: all 220ms ease;
    }
    .overlay.open { opacity:1; pointer-events:auto; }

    .modal {
      width:520px;
      max-width:96%;
      background: var(--card);
      border-radius:12px;
      padding:18px;
      box-shadow: 0 30px 80px rgba(10,8,6,0.35);
      border: 1px solid rgba(0,0,0,0.06);
      font-family:Lora, serif;
    }
    .modal h2 { margin:0 0 8px 0; font-family: 'Playfair Display', serif; color:var(--ink); }
    .modal label { font-size:13px; color:var(--muted); margin-top:10px; display:block; }
    .modal input, .modal textarea, .modal select {
      width:100%; padding:10px 12px; border-radius:8px; border:1px solid rgba(0,0,0,0.06); background:transparent; color:var(--ink); font-size:14px;
      margin-top:6px;
    }
    .modal textarea { min-height:96px; resize:vertical; }
    .row-2 { display:grid; grid-template-columns: 1fr 1fr; gap:10px; }

    .submit {
      margin-top:12px;
      display:inline-block;
      padding:10px 12px;
      border-radius:8px;
      border:none;
      background:var(--olive);
      color:#fff;
      font-weight:700;
      cursor:pointer;
    }
    .close {
      background:transparent; border:none; font-size:18px; cursor:pointer; color:var(--muted);
    }

    /* small message area */
    #msg { margin-top:12px; font-size:13px; color:#7a2b2b; display:none; }

    @media (max-width:680px){
      .controls { flex-direction:column; align-items:stretch; gap:10px; }
      .catalog { grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); }
      .modal { width:92%; padding:14px; }
      .fab { right:16px; bottom:16px; }
    }
  </style>
</head>
<body>
  <div class="page">
    <header>
      <div class="brand">
        <div>
          <h1>Bibliotheca</h1>
          <div class="tagline">mi colecci√≥n ‚Ä¢ biblioteca personal</div>
        </div>
      </div>
    </header>

    <!-- üìä Library Stats -->
    <div class="stats">
        <div class="stat">
            <h2 id="totalBooks">0</h2>
            <p>Total libros</p>
        </div>
        <div class="stat">
            <h2 id="booksRead">0</h2>
            <p>Le√≠dos</p>
        </div>.
        <div class="stat">
            <h2 id="booksReading">0</h2>
            <p>Actualmente leyendo</p>
        </div>
    </div>


    <main class="stage" aria-live="polite">
      <div class="controls">
        <div class="left-controls">
          <div class="search">
            <input id="searchInput" placeholder="Buscar por t√≠tulo, autor o g√©nero..." aria-label="Buscar libros">
          </div>
          <div class="filters">
            <select id="genreFilter"><option value="">Todos los g√©neros</option></select>
            <select id="statusFilter"><option value="">Todos los estados</option><option value="Unread">Unread</option><option value="Reading">Reading</option><option value="Read">Read</option></select>
          </div>
        </div>

        <div>
          <button class="fab" id="fabBtn">+ A√±adir</button>
        </div>
      </div>

      <div id="msg"></div>

      <section class="catalog" id="catalog">
        <!-- cards injected here -->
      </section>
    </main>
  </div>

  <!-- modal -->
  <div class="overlay" id="overlay" aria-hidden="true">
    <div class="modal" role="dialog" aria-modal="true" aria-labelledby="modalTitle">
      <div style="display:flex; justify-content:space-between; align-items:center; gap:10px;">
        <h2 id="modalTitle">A√±adir libro</h2>
        <button class="close" id="closeModal" title="Cerrar">‚úï</button>
      </div>

      <form id="addForm">
        <label for="title">T√≠tulo *</label>
        <input id="title" name="title" required>

        <label for="author">Autor *</label>
        <input id="author" name="author" required>

        <div class="row-2">
          <div>
            <label for="isbn">ISBN</label>
            <input id="isbn" name="isbn">
          </div>
          <div>
            <label for="year">A√±o</label>
            <input id="year" name="year" type="number" placeholder="YYYY">
          </div>
        </div>

        <label for="genre">G√©nero</label>
        <select id="genre">
            <option value="">Selecciona un g√©nero</option>
            <option value="Ficci√≥n">Ficci√≥n</option>
            <option value="No Ficci√≥n">No Ficci√≥n</option>
            <option value="Poes√≠a">Poes√≠a</option>
            <option value="Ensayo">Ensayo</option>
            <option value="Historia">Historia</option>
            <option value="Filosof√≠a">Filosof√≠a</option>
            <option value="Ciencia">Ciencia</option>
            <option value="Arte">Arte</option>
            <option value="Biograf√≠a">Biograf√≠a</option>
            <option value="Otro">Otro</option>
        </select>

        <label for="status">Estado</label>
        <select id="status" name="status">
          <option>Unread</option>
          <option>Reading</option>
          <option>Read</option>
        </select>

        <label for="notes">Notas</label>
        <textarea id="notes" name="notes"></textarea>

        <button class="submit" type="submit">Guardar</button>
      </form>
    </div>
  </div>

  <script>
    // -------------------
    //  REPLACE THESE TWO
    // -------------------
    const SUPABASE_URL = 'https://nkjljspmdtmgcvqiqdrq.supabase.co';
    const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im5ramxqc3BtZHRtZ2N2cWlxZHJxIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjIzNzU0MzIsImV4cCI6MjA3Nzk1MTQzMn0.hww7AocVOqLS9jtJfARmCPEeDamrxrZl1u-8DyI5n7U';
    // -------------------

    // basic UI refs
    const overlay = document.getElementById('overlay');
    const fabBtn = document.getElementById('fabBtn');
    const closeModal = document.getElementById('closeModal');
    const addForm = document.getElementById('addForm');
    const catalogEl = document.getElementById('catalog');
    const msgEl = document.getElementById('msg');
    const searchInput = document.getElementById('searchInput');
    const genreFilter = document.getElementById('genreFilter');
    const statusFilter = document.getElementById('statusFilter');

    function showMsg(text, isError = true) {
      msgEl.style.display = 'block';
      msgEl.style.color = isError ? '#7a2b2b' : '#2f5a2f';
      msgEl.textContent = text;
      if (!isError) setTimeout(()=>{ msgEl.style.display='none' }, 2200);
    }

    if (!SUPABASE_URL || SUPABASE_URL.includes('YOUR_SUPABASE')) {
      showMsg('Reemplaza SUPABASE_URL con la URL de tu proyecto Supabase.');
      console.error('Missing SUPABASE_URL');
    }
    if (!SUPABASE_KEY || SUPABASE_KEY.includes('YOUR_SUPABASE')) {
      showMsg('Reemplaza SUPABASE_KEY con la anon/public key de Supabase.');
      console.error('Missing SUPABASE_KEY');
    }

    // init supabase
    const supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

    let books = [];

    // modal handlers
    function openModal(){ overlay.classList.add('open'); overlay.classList.add('open'); overlay.setAttribute('aria-hidden','false'); document.getElementById('title').focus(); }
    function closeModalFn(){ overlay.classList.remove('open'); overlay.setAttribute('aria-hidden','true'); addForm.reset(); }
    fabBtn.addEventListener('click', openModal);
    closeModal.addEventListener('click', closeModalFn);
    overlay.addEventListener('click', (e) => { if (e.target === overlay) closeModalFn(); });
    document.addEventListener('keydown', (e)=>{ if (e.key === 'Escape') closeModalFn(); });

    // fetch books
    async function fetchBooks(){
      try {
        const { data, error } = await supabaseClient
          .from('books')
          .select('*')
          .order('created_at', { ascending: false });

        if (error) {
          console.error('fetch error', error);
          showMsg('Error al cargar libros. Revisa la consola.');
          return;
        }
        books = data || [];
        renderCatalog();
        updateStats();
        populateGenres();
        showMsg('Cat√°logo cargado', false);
      } catch (e) {
        console.error(e);
        showMsg('Error inesperado al obtener datos.');
      }
    }

    function renderCatalog(){
      const q = (searchInput.value || '').trim().toLowerCase();
      const g = genreFilter.value;
      const s = statusFilter.value;

      const filtered = books.filter(b => {
        if (q) {
          const text = `${b.title || ''} ${b.author || ''} ${b.genre || ''}`.toLowerCase();
          if (!text.includes(q)) return false;
        }
        if (g && b.genre !== g) return false;
        if (s && b.status !== s) return false;
        return true;
      });

      catalogEl.innerHTML = '';
      if (filtered.length === 0) {
        catalogEl.innerHTML = '<div style="padding:18px; color:var(--muted)">No hay libros que coincidan.</div>';
        return;
      }

      for (const b of filtered) {
        const card = document.createElement('article');
        card.className = 'card';
        const created = b.created_at ? new Date(b.created_at).toLocaleDateString() : '';
        card.innerHTML = `
          <div>
            <h3>${escapeHtml(b.title || '‚Äî')}</h3>
            <div class="meta">${escapeHtml(b.author || '‚Äî')}</div>
            <div class="muted" style="margin-top:6px">${escapeHtml(b.genre || 'Sin g√©nero')} ‚Ä¢ ${b.year || '‚Äî'}</div>
          </div>

          <div class="row">
            <div class="badge">${escapeHtml(b.status || 'Unread')}</div>
            <div class="muted">${created}</div>
          </div>

          <div class="notes">${escapeHtml(b.notes || '')}</div>

          <div class="row" style="margin-top:10px">
            <div class="muted">ISBN: ${escapeHtml(b.isbn || '‚Äî')}</div>
            <div class="actions">
              <button class="tiny" data-id="${b.id}" data-action="toggle">Toggle</button>
              <button class="tiny danger" data-id="${b.id}" data-action="delete">Borrar</button>
            </div>
          </div>
        `;
        catalogEl.appendChild(card);
      }

      // attach handlers
      catalogEl.querySelectorAll('button[data-action]').forEach(btn=>{
        btn.onclick = async () => {
          const id = btn.getAttribute('data-id');
          const action = btn.getAttribute('data-action');
          if (action === 'delete') {
            if (!confirm('¬øEliminar este libro?')) return;
            await deleteBook(id);
          } else if (action === 'toggle') {
            await toggleBookStatus(id);
          }
        };
      });
    }

    // helpers
    function escapeHtml(s='') {
      return String(s).replaceAll('&','&amp;').replaceAll('<','&lt;').replaceAll('>','&gt;').replaceAll('"','&quot;').replaceAll("'",'&#39;');
    }

    function populateGenres(){
      const genres = [...new Set(books.map(b => b.genre).filter(Boolean))].sort();
      genreFilter.innerHTML = '<option value="">Todos los g√©neros</option>';
      for (const g of genres) {
        const o = document.createElement('option'); o.value = g; o.textContent = g;
        genreFilter.appendChild(o);
      }
    }

    // add
    addForm.addEventListener('submit', async (e)=>{
      e.preventDefault();
      const newBook = {
        title: (document.getElementById('title').value || '').trim(),
        author: (document.getElementById('author').value || '').trim(),
        isbn: (document.getElementById('isbn').value || '').trim() || null,
        genre: (document.getElementById('genre').value || '').trim() || null,
        year: parseInt(document.getElementById('year').value) || null,
        status: (document.getElementById('status').value || 'Unread'),
        notes: (document.getElementById('notes').value || '').trim() || null
      };

      if (!newBook.title || !newBook.author) {
        showMsg('T√≠tulo y autor son obligatorios.');
        return;
      }

      try {
        const { data, error } = await supabaseClient.from('books').insert([newBook]).select();
        if (error) {
          console.error('Insert error', error);
          showMsg('No se pudo a√±adir el libro. Revisa la consola.');
        } else {
          showMsg('Libro a√±adido', false);
          closeModalFn();
          fetchBooks();
        }
      } catch (err) {
        console.error(err);
        showMsg('Error inesperado al a√±adir libro.');
      }
    });

    // delete
    async function deleteBook(id){
      try {
        const { error } = await supabaseClient.from('books').delete().eq('id', id);
        if (error) {
          console.error('Delete error', error);
          showMsg('No se pudo borrar. Revisa la consola.');
        } else {
          showMsg('Libro eliminado', false);
          fetchBooks();
        }
      } catch (err) {
        console.error(err);
        showMsg('Error inesperado al borrar.');
      }
    }

    // toggle
    async function toggleBookStatus(id) {
      try {
        const book = books.find(b => String(b.id) === String(id));
        if (!book) { showMsg('Libro no encontrado'); return; }
        const next = book.status === 'Unread' ? 'Reading' : (book.status === 'Reading' ? 'Read' : 'Unread');
        const { error } = await supabaseClient.from('books').update({ status: next }).eq('id', id);
        if (error) {
          console.error('Toggle error', error);
          showMsg('No se pudo actualizar estado.');
        } else {
          showMsg('Estado actualizado', false);
          fetchBooks();
        }
      } catch (err) {
        console.error(err);
        showMsg('Error inesperado al cambiar estado.');
      }
    }

    // filters & search
    searchInput.addEventListener('input', () => renderCatalog());
    genreFilter.addEventListener('change', () => renderCatalog());
    statusFilter.addEventListener('change', () => renderCatalog());

    // expose close fn
    function closeModalFn(){ overlay.classList.remove('open'); overlay.setAttribute('aria-hidden','true'); addForm.reset(); }
    function openModal(){ overlay.classList.add('open'); overlay.setAttribute('aria-hidden','false'); document.getElementById('title').focus(); }

    // wire open/close also for fab
    document.getElementById('fabBtn').addEventListener('click', openModal);
    document.getElementById('closeModal').addEventListener('click', closeModalFn);

    // initial load
    fetchBooks();

    // Escape to close
    document.addEventListener('keydown', (e)=>{ if (e.key === 'Escape') closeModalFn(); });

    // Stats
    function updateStats() {
        const total = books.length;
        const read = books.filter(b => b.status === 'Read').length;
        const reading = books.filter(b => b.status === 'Reading').length;

        document.getElementById('totalBooks').textContent = total;
        document.getElementById('booksRead').textContent = read;
        document.getElementById('booksReading').textContent = reading;
    }


  </script>
</body>
</html>
