<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Mi Biblioteca</title>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <style>
    :root {
      --bg: #071226;
      --card: #0b1420;
      --input: #0f1a28;
      --gold: #d6b64a;
      --muted: #9aa3ad;
      --accent-text: #f6e9b0;
    }
    body {
      margin: 0;
      font-family: Inter, system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial;
      background: radial-gradient(1200px 400px at 10% 10%, rgba(13,24,43,0.35), transparent),
                  linear-gradient(180deg, var(--bg), #051021 120%);
      color: var(--accent-text);
      -webkit-font-smoothing:antialiased;
    }
    .wrap {
      max-width: 980px;
      margin: 28px auto;
      padding: 20px;
    }
    header {
      display:flex;
      align-items:center;
      gap:12px;
      margin-bottom:18px;
    }
    h1 { margin:0; color:var(--gold); letter-spacing:1px; font-size:22px; }
    .container {
      background: linear-gradient(180deg, rgba(255,255,255,0.02), rgba(0,0,0,0.02));
      border-radius: 14px;
      padding: 18px;
      border: 1px solid rgba(214,182,74,0.08);
      box-shadow: 0 10px 30px rgba(2,6,23,0.6);
    }
    form .row { display:grid; grid-template-columns: repeat(2,1fr); gap:12px; }
    label { display:block; font-size:12px; color:var(--muted); margin-bottom:6px; }
    input, select, textarea {
      width:100%;
      background: var(--input);
      border: 1px solid rgba(214,182,74,0.06);
      padding:10px 12px;
      border-radius:10px;
      color:var(--accent-text);
      font-size:14px;
      outline:none;
    }
    textarea { min-height:72px; resize:vertical; }
    .actions { margin-top:12px; display:flex; gap:12px; }
    button.primary {
      background: linear-gradient(180deg,var(--gold), #c9a43d);
      color:#04121a;
      border:none;
      padding:10px 14px;
      border-radius:10px;
      font-weight:700;
      cursor:pointer;
    }
    .stats { display:flex; gap:12px; margin-top:18px; }
    .stat { flex:1; background:var(--card); padding:14px; border-radius:10px; text-align:center; border:1px solid rgba(255,255,255,0.02); }
    .stat h2 { margin:0; color:var(--gold); font-size:20px; }
    .stat p { margin:0; color:var(--muted); font-size:12px; }
    .book-list { margin-top:18px; display:grid; gap:10px; }
    .book {
      background: linear-gradient(180deg, rgba(255,255,255,0.01), rgba(0,0,0,0.02));
      border-radius:10px; padding:10px; display:flex; gap:12px; align-items:flex-start; border:1px solid rgba(214,182,74,0.03);
    }
    .book .meta { flex:1; }
    .book h3 { margin:0 0 6px 0; color:var(--gold); font-size:16px; }
    .book small { color:var(--muted); display:block; margin-bottom:6px; }
    .book p { margin:0; color:var(--accent-text); font-size:13px; }
    .book .controls { display:flex; gap:8px; flex-direction:column; }
    .btn-outline {
      background:none; border:1px solid rgba(214,182,74,0.12); padding:6px 10px; border-radius:8px; color:var(--gold); cursor:pointer;
    }
    #msg { margin-top:12px; color:#ffcccb; background:#2a0f0f33; padding:8px 10px; border-radius:8px; display:none; }
    .filters { margin-top:12px; display:flex; gap:10px; align-items:center; }
    .search { flex:1; }
  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <h1>ðŸ“š Mi Biblioteca</h1>
    </header>

    <div class="container">
      <div id="msg"></div>

      <form id="bookForm">
        <div style="display:flex; gap:12px; margin-bottom:10px;">
          <div style="flex:1">
            <label>TÃ­tulo *</label>
            <input id="title" required />
          </div>
          <div style="flex:1">
            <label>Autor *</label>
            <input id="author" required />
          </div>
        </div>

        <div style="display:flex; gap:12px;">
          <div style="flex:1">
            <label>ISBN</label>
            <input id="isbn" />
          </div>
          <div style="flex:1">
            <label>GÃ©nero</label>
            <input id="genre" />
          </div>
        </div>

        <div style="display:flex; gap:12px; margin-top:10px;">
          <div style="width:160px">
            <label>AÃ±o</label>
            <input id="year" type="number" placeholder="YYYY" />
          </div>
          <div style="flex:1">
            <label>Status</label>
            <select id="status">
              <option>Unread</option>
              <option>Reading</option>
              <option>Read</option>
            </select>
          </div>
        </div>

        <div style="margin-top:10px;">
          <label>Notas</label>
          <textarea id="notes"></textarea>
        </div>

        <div class="actions">
          <button type="submit" class="primary">AÃ±adir a la colecciÃ³n</button>
          <button type="button" id="refreshBtn" class="btn-outline">Refrescar</button>
        </div>
      </form>

      <div class="filters">
        <input id="search" class="search" placeholder="Buscar tÃ­tulo o autor..." />
        <select id="filterGenre"><option value="">Todos los gÃ©neros</option></select>
        <select id="filterStatus"><option value="">Todos los status</option><option>Unread</option><option>Reading</option><option>Read</option></select>
      </div>

      <div class="stats">
        <div class="stat">
          <h2 id="totalBooks">0</h2>
          <p>Total libros</p>
        </div>
        <div class="stat">
          <h2 id="booksRead">0</h2>
          <p>LeÃ­dos</p>
        </div>
        <div class="stat">
          <h2 id="booksReading">0</h2>
          <p>Actualmente leyendo</p>
        </div>
      </div>

      <div class="book-list" id="bookList"></div>
    </div>
  </div>

  <script>
    // -------------------
    //  REPLACE THESE TWO
    // -------------------
    const SUPABASE_URL = 'https://nkjljspmdtmgcvqiqdrq.supabase.co';
    const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im5ramxqc3BtZHRtZ2N2cWlxZHJxIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjIzNzU0MzIsImV4cCI6MjA3Nzk1MTQzMn0.hww7AocVOqLS9jtJfARmCPEeDamrxrZl1u-8DyI5n7U';
    // -------------------

    const msg = document.getElementById('msg');
    function showMsg(text, isError = true) {
      msg.style.display = 'block';
      msg.style.color = isError ? '#ffdede' : '#e6f9e6';
      msg.textContent = text;
      if (!isError) setTimeout(() => { msg.style.display = 'none'; }, 2500);
    }

    if (!SUPABASE_URL || SUPABASE_URL.includes('YOUR_SUPABASE')) {
      showMsg('Por favor reemplaza SUPABASE_URL en el archivo con tu URL de proyecto Supabase.');
      console.error('Missing SUPABASE_URL');
    }
    if (!SUPABASE_KEY || SUPABASE_KEY.includes('YOUR_SUPABASE')) {
      showMsg('Por favor reemplaza SUPABASE_KEY en el archivo con tu anon/public key de Supabase.');
      console.error('Missing SUPABASE_KEY');
    }

    // create client safely
    const supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

    // helpers
    const form = document.getElementById('bookForm');
    const bookList = document.getElementById('bookList');
    const totalBooksEl = document.getElementById('totalBooks');
    const booksReadEl = document.getElementById('booksRead');
    const booksReadingEl = document.getElementById('booksReading');
    const searchEl = document.getElementById('search');
    const filterGenre = document.getElementById('filterGenre');
    const filterStatus = document.getElementById('filterStatus');
    const refreshBtn = document.getElementById('refreshBtn');

    let allBooks = [];

    async function fetchBooks() {
      try {
        const { data, error } = await supabaseClient
          .from('books')
          .select('*')
          .order('id', { ascending: false });

        if (error) {
          console.error('Error fetching books', error);
          showMsg('Error al traer libros. Revisa la consola para mÃ¡s detalles.');
          return;
        }
        allBooks = data || [];
        renderBooks(allBooks);
        updateStats(allBooks);
        populateGenres(allBooks);
        showMsg('Datos cargados', false);
        console.log('books loaded', allBooks);
      } catch (err) {
        console.error('Unexpected error', err);
        showMsg('Error inesperado al obtener datos. Mira la consola.');
      }
    }

    function renderBooks(books) {
      const q = searchEl.value.trim().toLowerCase();
      const g = filterGenre.value;
      const s = filterStatus.value;
      const filtered = books.filter(b => {
        if (q) {
          const combined = `${b.title || ''} ${b.author || ''}`.toLowerCase();
          if (!combined.includes(q)) return false;
        }
        if (g && b.genre !== g) return false;
        if (s && b.status !== s) return false;
        return true;
      });

      bookList.innerHTML = '';
      if (filtered.length === 0) {
        bookList.innerHTML = '<p style="color:var(--muted)">No hay libros que coincidan.</p>';
        return;
      }

      for (const book of filtered) {
        const el = document.createElement('div');
        el.className = 'book';
        el.innerHTML = `
          <div class="meta">
            <h3>${escapeHtml(book.title || 'â€”')}</h3>
            <small>${escapeHtml(book.author || 'â€”')} â€” ${escapeHtml(book.genre || 'Sin gÃ©nero')} (${book.year || 'YYYY'})</small>
            <p><strong>Status:</strong> ${escapeHtml(book.status || 'Unread')}</p>
            <p style="margin-top:6px; color:var(--muted)"><em>${escapeHtml(book.notes || '')}</em></p>
          </div>
          <div class="controls">
            <button class="btn-outline" data-id="${book.id}" data-action="delete">Borrar</button>
            <button class="btn-outline" data-id="${book.id}" data-action="toggle">Toggle Status</button>
          </div>
        `;
        bookList.appendChild(el);
      }

      // attach handlers
      bookList.querySelectorAll('button[data-action]').forEach(btn => {
        btn.onclick = async (e) => {
          const id = btn.getAttribute('data-id');
          const action = btn.getAttribute('data-action');
          if (action === 'delete') {
            if (!confirm('Â¿Eliminar este libro?')) return;
            await deleteBook(id);
          } else if (action === 'toggle') {
            await toggleStatus(id);
          }
        };
      });
    }

    function updateStats(books) {
      totalBooksEl.textContent = books.length;
      booksReadEl.textContent = books.filter(b => b.status === 'Read').length;
      booksReadingEl.textContent = books.filter(b => b.status === 'Reading').length;
    }

    function populateGenres(books) {
      const genres = [...new Set(books.map(b => b.genre).filter(Boolean))].sort();
      filterGenre.innerHTML = '<option value="">Todos los gÃ©neros</option>';
      genres.forEach(g => {
        const o = document.createElement('option');
        o.value = g;
        o.textContent = g;
        filterGenre.appendChild(o);
      });
    }

    async function deleteBook(id) {
      try {
        const { error } = await supabaseClient.from('books').delete().eq('id', id);
        if (error) {
          console.error('Delete error', error);
          showMsg('No se pudo borrar. Revisa la consola.');
        } else {
          showMsg('Libro eliminado', false);
          fetchBooks();
        }
      } catch (err) {
        console.error(err);
        showMsg('Error inesperado al borrar.');
      }
    }

    async function toggleStatus(id) {
      try {
        const book = allBooks.find(b => `${b.id}` === `${id}`);
        if (!book) return showMsg('Libro no encontrado');
        const next = book.status === 'Unread' ? 'Reading' : (book.status === 'Reading' ? 'Read' : 'Unread');
        const { error } = await supabaseClient.from('books').update({ status: next }).eq('id', id);
        if (error) {
          console.error('Toggle error', error);
          showMsg('No se pudo actualizar el status.');
        } else {
          showMsg('Status actualizado', false);
          fetchBooks();
        }
      } catch (err) {
        console.error(err);
        showMsg('Error inesperado al cambiar status.');
      }
    }

    form.addEventListener('submit', async (ev) => {
      ev.preventDefault();
      const newBook = {
        title: document.getElementById('title').value.trim(),
        author: document.getElementById('author').value.trim(),
        isbn: document.getElementById('isbn').value.trim() || null,
        genre: document.getElementById('genre').value.trim() || null,
        year: parseInt(document.getElementById('year').value) || null,
        status: document.getElementById('status').value,
        notes: document.getElementById('notes').value.trim() || null
      };

      if (!newBook.title || !newBook.author) {
        showMsg('TÃ­tulo y autor son obligatorios');
        return;
      }

      try {
        const { data, error } = await supabaseClient.from('books').insert([newBook]).select();
        if (error) {
          console.error('Insert error', error);
          showMsg('No se pudo aÃ±adir el libro. Revisa la consola.');
        } else {
          showMsg('Libro aÃ±adido', false);
          form.reset();
          fetchBooks();
        }
      } catch (err) {
        console.error(err);
        showMsg('Error inesperado al insertar libro.');
      }
    });

    // filters
    searchEl.addEventListener('input', () => renderBooks(allBooks));
    filterGenre.addEventListener('change', () => renderBooks(allBooks));
    filterStatus.addEventListener('change', () => renderBooks(allBooks));
    refreshBtn.addEventListener('click', fetchBooks);

    // small html-escape helper
    function escapeHtml(s = '') {
      return String(s)
        .replaceAll('&', '&amp;')
        .replaceAll('<', '&lt;')
        .replaceAll('>', '&gt;')
        .replaceAll('"', '&quot;')
        .replaceAll("'", '&#39;');
    }

    // expose deleteBook in case you used inline handlers elsewhere
    window.deleteBook = deleteBook;

    // initial load
    fetchBooks();
  </script>
</body>
</html>
